<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auditoria de Galpão - Gestão de Pacotes</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#764ba2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Auditoria Galpão">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Poppins', sans-serif; }

    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .glass-effect { background: rgba(255,255,255,.95); backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,.2); }
    .card-hover { transition: .3s; }
    .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,.1); }

    .camera-preview{ width:100%; height:250px; background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%); border-radius:20px; display:flex; align-items:center; justify-content:center; border:3px dashed #8b5cf6; position:relative; overflow:hidden;}
    .camera-preview::before{ content:''; position:absolute; inset:0; background:linear-gradient(45deg,transparent 25%, rgba(139,92,246,.1) 25%, rgba(139,92,246,.1) 50%, transparent 50%, transparent 75%, rgba(139,92,246,.1) 75%); background-size:20px 20px; animation:move 2s linear infinite;}
    @keyframes move{0%{background-position:0 0}100%{background-position:20px 20px}}
    .photo-preview{width:100%; height:250px; object-fit:cover; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .status-badge{ padding:8px 16px; border-radius:25px; font-size:12px; font-weight:600; text-transform:uppercase; letter-spacing:1px; }
    .status-reprocessar { background:linear-gradient(135deg,#ffecd2 0%,#fcb69f 100%); color:#8b4513; box-shadow:0 4px 15px rgba(252,182,159,.4); }
    .status-reversa { background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 100%); color:#dc2626; box-shadow:0 4px 15px rgba(255,154,158,.4); }
    .status-fc { background:linear-gradient(135deg,#a18cd1 0%,#fbc2eb 100%); color:#7c3aed; box-shadow:0 4px 15px rgba(161,140,209,.4); }
    .btn-primary{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); border:none; padding:12px 30px; border-radius:15px; font-weight:600; text-transform:uppercase; letter-spacing:1px; transition:.3s; box-shadow:0 8px 25px rgba(102,126,234,.3); }
    .btn-primary:hover{ transform:translateY(-2px); box-shadow:0 15px 35px rgba(102,126,234,.4); }
    .btn-success{ background:linear-gradient(135deg,#84fab0 0%,#8fd3f4 100%); color:#065f46; border:none; padding:12px 30px; border-radius:15px; font-weight:600; text-transform:uppercase; letter-spacing:1px; transition:.3s; box-shadow:0 8px 25px rgba(132,250,176,.3); }
    .btn-success:hover{ transform:translateY(-2px); box-shadow:0 15px 35px rgba(132,250,176,.4); }
    .btn-danger{ background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 100%); color:#dc2626; border:none; padding:12px 30px; border-radius:15px; font-weight:600; text-transform:uppercase; letter-spacing:1px; transition:.3s; box-shadow:0 8px 25px rgba(255,154,158,.3); }
    .btn-danger:hover{ transform:translateY(-2px); box-shadow:0 15px 35px rgba(255,154,158,.4); }
    .input-modern{ border:2px solid #e5e7eb; border-radius:15px; padding:12px 20px; transition:.3s; background:rgba(255,255,255,.9); }
    .input-modern:focus{ border-color:#8b5cf6; box-shadow:0 0 0 3px rgba(139,92,246,.1); transform:translateY(-1px); }
    .floating-elements{ position:fixed; inset:0; pointer-events:none; z-index:-1; }
    .floating-circle{ position:absolute; border-radius:50%; background:linear-gradient(135deg, rgba(139,92,246,.1), rgba(102,126,234,.1)); animation:float 6s ease-in-out infinite;}
    @keyframes float{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-20px) rotate(180deg)}}
    .record-card{ background:linear-gradient(135deg, rgba(255,255,255,.9) 0%, rgba(255,255,255,.7) 100%); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,.3); border-radius:20px; transition:.3s; }
    .record-card:hover{ transform:translateX(10px); box-shadow:0 20px 40px rgba(0,0,0,.1); }
    .stats-card{ background:linear-gradient(135deg, rgba(255,255,255,.95) 0%, rgba(255,255,255,.8) 100%); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,.2); border-radius:20px; transition:.3s; }
    .stats-card:hover{ transform:translateY(-5px) scale(1.02); }
    @media print{ .no-print{ display:none !important; } }
    .pulse-animation{ animation:pulse 2s infinite; }
    @keyframes pulse{ 0%{ box-shadow:0 0 0 0 rgba(139,92,246,.7);} 70%{ box-shadow:0 0 0 10px rgba(139,92,246,0);} 100%{ box-shadow:0 0 0 0 rgba(139,92,246,0);} }
    .date-filter-container{ background:linear-gradient(135deg, rgba(255,255,255,.9) 0%, rgba(255,255,255,.7) 100%); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,.3); border-radius:20px; padding:20px; margin-bottom:20px;}
    .tab-button{ padding:10px 20px; border-radius:25px; border:2px solid transparent; transition:.3s; font-weight:600; text-transform:uppercase; letter-spacing:1px; cursor:pointer; }
    .tab-button.active{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; box-shadow:0 8px 25px rgba(102,126,234,.3); }
    .tab-button:not(.active){ background:rgba(255,255,255,.7); color:#667eea; border-color:#667eea; }
    .tab-button:not(.active):hover{ background:rgba(102,126,234,.1); }

    /* PWA Install Button */
    .pwa-install{ position:fixed; bottom:20px; right:20px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border:none; padding:12px 16px; border-radius:50px; font-weight:600; box-shadow:0 8px 25px rgba(102,126,234,.4); z-index:1000; display:none; animation:bounce 2s infinite; }
    @keyframes bounce{ 0%,20%,50%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-10px)} 60%{transform:translateY(-5px)} }
  </style>
</head>

<body class="min-h-screen relative overflow-x-hidden">
  <!-- PWA Install -->
  <button id="installButton" class="pwa-install">
    <i class="fas fa-download mr-2"></i>Instalar App
  </button>

  <!-- Floating Background -->
  <div class="floating-elements">
    <div class="floating-circle" style="top:10%; left:5%; width:100px; height:100px; animation-delay:0s;"></div>
    <div class="floating-circle" style="top:60%; right:10%; width:150px; height:150px; animation-delay:2s;"></div>
    <div class="floating-circle" style="bottom:20%; left:15%; width:80px; height:80px; animation-delay:4s;"></div>
    <div class="floating-circle" style="top:30%; right:20%; width:60px; height:60px; animation-delay:1s;"></div>
  </div>

  <!-- Background -->
  <div class="fixed inset-0 gradient-bg"></div>

  <!-- Header -->
  <header class="relative z-10">
    <div class="glass-effect shadow-xl">
      <div class="container mx-auto px-6 py-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-blue-500 rounded-xl flex items-center justify-center text-white text-xl font-bold">
              <i class="fas fa-warehouse"></i>
            </div>
            <div>
              <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">Auditoria de Galpão</h1>
              <p class="text-gray-600 text-sm">Sistema de Gestão de Pacotes</p>
            </div>
          </div>
          <div class="flex items-center space-x-6">
            <div class="text-right">
              <p class="text-sm text-gray-600">Data/Hora Atual</p>
              <p id="currentDate" class="font-semibold text-gray-800"></p>
            </div>
            <button onclick="showReports()" class="btn-primary text-white no-print">
              <i class="fas fa-chart-bar mr-2"></i>Relatórios
            </button>
            <button onclick="showHistoricalReports()" class="btn-success no-print">
              <i class="fas fa-history mr-2"></i>Histórico
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <div class="relative z-10 container mx-auto px-6 py-8">

    <!-- Form -->
    <div id="scanSection" class="glass-effect rounded-3xl shadow-2xl p-8 mb-8 card-hover">
      <div class="flex items-center mb-8">
        <div class="w-16 h-16 bg-gradient-to-r from-green-400 to-blue-500 rounded-2xl flex items-center justify-center text-white text-2xl mr-4 pulse-animation">
          <i class="fas fa-barcode"></i>
        </div>
        <div>
          <h2 class="text-3xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Registrar Pacote</h2>
          <p class="text-gray-600">Digite os dados do pacote devolvido</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left -->
        <div class="space-y-6">
          <!-- TBR -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3">
              <i class="fas fa-hashtag mr-2"></i>TBR do Pacote
            </label>
            <div class="flex">
              <input type="text" id="tbrInput" placeholder="Digite ou escaneie o TBR" class="flex-1 input-modern focus:outline-none">
              <button onclick="scanBarcode()" class="ml-3 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-6 py-3 rounded-xl transition-all">
                <i class="fas fa-qrcode"></i>
              </button>
            </div>
            <!-- Área do leitor QR -->
            <div id="reader" style="width:320px; max-width:100%; margin:10px 0; display:none;"></div>
          </div>

          <!-- Motivo -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3">
              <i class="fas fa-exclamation-triangle mr-2"></i>Motivo da Devolução
            </label>
            <select id="motivoSelect" class="w-full input-modern focus:outline-none">
              <option value="">Selecione o motivo</option>
              <option value="Endereço incorreto">Endereço incorreto</option>
              <option value="Destinatário ausente">Destinatário ausente</option>
              <option value="Recusado pelo destinatário">Recusado pelo destinatário</option>
              <option value="Produto danificado">Produto danificado</option>
              <option value="Não localizado">Não localizado</option>
              <option value="CEP inexistente">CEP inexistente</option>
              <option value="Outros">Outros</option>
            </select>
          </div>

          <!-- Ação -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3">
              <i class="fas fa-cogs mr-2"></i>Ação Necessária
            </label>
            <select id="acaoSelect" class="w-full input-modern focus:outline-none" onchange="toggleReprocessDate()">
              <option value="">Selecione a ação</option>
              <option value="Reprocessar">Reprocessar</option>
              <option value="Reversa">Reversa</option>
              <option value="FC">FC (Fim de Ciclo)</option>
            </select>
          </div>

          <!-- Data Reprocessamento -->
          <div id="reprocessDateDiv" class="hidden">
            <label class="block text-sm font-semibold text-gray-700 mb-3">
              <i class="fas fa-calendar-alt mr-2"></i>Data para Reprocessamento
            </label>
            <input type="date" id="reprocessDate" class="w-full input-modern focus:outline-none">
          </div>

          <!-- Observações -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3">
              <i class="fas fa-comment mr-2"></i>Observações
            </label>
            <textarea id="observacoes" placeholder="Digite observações adicionais..." class="w-full input-modern focus:outline-none h-24 resize-none"></textarea>
          </div>
        </div>

        <!-- Right -->
        <div class="space-y-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3">
              <i class="fas fa-camera mr-2"></i>Foto do Pacote
            </label>
            <div id="cameraSection" class="camera-preview cursor-pointer" onclick="document.getElementById('photoInput').click()">
              <div class="text-center text-gray-600 relative z-10">
                <i class="fas fa-camera text-6xl mb-4 text-purple-500"></i>
                <p class="text-lg font-semibold">Clique para tirar foto</p>
                <p class="text-sm opacity-75">Ou arraste uma imagem aqui</p>
              </div>
            </div>
            <img id="photoPreview" class="photo-preview hidden" alt="Prévia da foto do pacote">
            <input type="file" id="photoInput" accept="image/*" capture="camera" class="hidden" onchange="previewPhoto()">
            <div class="flex space-x-3 mt-4">
              <button onclick="document.getElementById('photoInput').click()" class="flex-1 btn-success">
                <i class="fas fa-camera mr-2"></i>Tirar Foto
              </button>
              <button onclick="clearPhoto()" class="btn-danger">
                <i class="fas fa-trash mr-2"></i>Limpar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Ações -->
      <div class="mt-8 flex flex-wrap gap-4 justify-center">
        <button onclick="savePackage()" class="btn-primary text-white px-12 py-4 text-lg">
          <i class="fas fa-save mr-3"></i>Salvar Registro
        </button>
        <button onclick="clearForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-12 py-4 rounded-lg font-600 text-lg transition-all">
          <i class="fas fa-eraser mr-3"></i>Limpar Formulário
        </button>
      </div>
    </div>

    <!-- Registros Recentes -->
    <div class="glass-effect rounded-3xl shadow-2xl p-8">
      <div class="flex items-center justify-between mb-8">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-gradient-to-r from-orange-400 to-pink-500 rounded-xl flex items-center justify-center text-white text-xl mr-4">
            <i class="fas fa-history"></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Registros Recentes</h2>
            <p class="text-gray-600">Últimos pacotes processados hoje</p>
          </div>
        </div>
        <div class="text-sm text-gray-500">
          <i class="fas fa-sync-alt mr-2"></i>Atualizado em tempo real
        </div>
      </div>
      <div id="recentRecords" class="space-y-4"></div>
    </div>
  </div>

  <!-- Modal Relatórios -->
  <div id="reportsModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 backdrop-blur-sm">
    <div class="flex items-center justify-center min-h-screen p-6">
      <div class="glass-effect rounded-3xl shadow-2xl max-w-7xl w-full max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center p-8 border-b border-gray-200">
          <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white text-xl mr-4">
              <i class="fas fa-chart-line"></i>
            </div>
            <div>
              <h2 class="text-3xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Relatórios do Dia</h2>
              <p class="text-gray-600">Análise completa dos pacotes processados hoje</p>
            </div>
          </div>
          <div class="flex space-x-3 no-print">
            <button onclick="exportReport()" class="btn-success"><i class="fas fa-download mr-2"></i>Exportar CSV</button>
            <button onclick="printReport()" class="btn-primary text-white"><i class="fas fa-print mr-2"></i>Imprimir</button>
            <button onclick="closeReports()" class="btn-danger"><i class="fas fa-times mr-2"></i>Fechar</button>
          </div>
        </div>
        <div class="p-8"><div id="reportContent"></div></div>
      </div>
    </div>
  </div>

  <!-- Modal Histórico -->
  <div id="historicalModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 backdrop-blur-sm">
    <div class="flex items-center justify-center min-h-screen p-6">
      <div class="glass-effect rounded-3xl shadow-2xl max-w-7xl w-full max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center p-8 border-b border-gray-200">
          <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-teal-600 rounded-xl flex items-center justify-center text-white text-xl mr-4">
              <i class="fas fa-calendar-week"></i>
            </div>
            <div>
              <h2 class="text-3xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Histórico de Relatórios</h2>
              <p class="text-gray-600">Consulte relatórios de qualquer período</p>
            </div>
          </div>
          <div class="flex space-x-3 no-print">
            <button onclick="exportHistoricalReport()" class="btn-success"><i class="fas fa-download mr-2"></i>Exportar Período</button>
            <button onclick="closeHistoricalReports()" class="btn-danger"><i class="fas fa-times mr-2"></i>Fechar</button>
          </div>
        </div>
        <div class="p-8">
          <!-- Filtros -->
          <div class="date-filter-container mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-filter mr-2"></i>Filtros de Data</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Data Inicial</label>
                <input type="date" id="startDate" class="w-full input-modern focus:outline-none">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Data Final</label>
                <input type="date" id="endDate" class="w-full input-modern focus:outline-none">
              </div>
              <div class="flex items-end">
                <button onclick="filterHistoricalData()" class="btn-primary text-white w-full"><i class="fas fa-search mr-2"></i>Buscar</button>
              </div>
            </div>
            <div class="flex flex-wrap gap-3">
              <button onclick="setQuickFilter('today')" class="tab-button">Hoje</button>
              <button onclick="setQuickFilter('week')" class="tab-button">Esta Semana</button>
              <button onclick="setQuickFilter('month')" class="tab-button">Este Mês</button>
              <button onclick="setQuickFilter('fc-reversa')" class="tab-button active">FC/Reversa</button>
            </div>
          </div>
          <div id="historicalContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="successToast" class="fixed top-6 right-6 bg-gradient-to-r from-green-400 to-blue-500 text-white px-8 py-4 rounded-2xl shadow-2xl hidden z-50 transform transition-all duration-500">
    <div class="flex items-center"><i class="fas fa-check-circle mr-3"></i><span class="font-semibold">Registro salvo com sucesso!</span></div>
  </div>

  <!-- ====== LÓGICA DO APP ====== -->
  <script>
    // Storage
    let packages = JSON.parse(localStorage.getItem('packages') || '[]');
    let currentPhoto = null;
    let deferredPrompt;

    // PWA Install
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); deferredPrompt = e;
      document.getElementById('installButton').style.display = 'block';
    });
    document.getElementById('installButton').addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') { showToast('App instalado com sucesso!', 'success'); document.getElementById('installButton').style.display='none'; }
      deferredPrompt = null;
    });

    // Init
    document.addEventListener('DOMContentLoaded', function() {
      updateCurrentDate(); loadRecentRecords(); setInterval(updateCurrentDate, 60000);
      setDefaultDates();
    });

    function setDefaultDates(){
      const today = new Date();
      const thirty = new Date(today.getTime() - 30*24*60*60*1000);
      document.getElementById('startDate').value = thirty.toISOString().split('T')[0];
      document.getElementById('endDate').value = today.toISOString().split('T')[0];
    }

    function updateCurrentDate(){
      const now = new Date();
      const dateStr = now.toLocaleDateString('pt-BR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}) + ' - ' + now.toLocaleTimeString('pt-BR');
      document.getElementById('currentDate').textContent = dateStr;
    }

    function toggleReprocessDate(){
      const acao = document.getElementById('acaoSelect').value;
      const div = document.getElementById('reprocessDateDiv');
      if (acao === 'Reprocessar'){
        div.classList.remove('hidden');
        const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
        document.getElementById('reprocessDate').value = tomorrow.toISOString().split('T')[0];
      } else {
        div.classList.add('hidden'); document.getElementById('reprocessDate').value='';
      }
    }

    // QR Code (usa html5-qrcode)
    let __qrReader = null;
    function scanBarcode(){
      const input = document.getElementById('tbrInput');
      const readerEl = document.getElementById('reader');
      if (!readerEl || !input) { showToast('Erro: campo/área do leitor não encontrados', 'error'); return; }
      if (typeof Html5Qrcode === 'undefined') { showToast('Leitor QR não carregou. Internet?', 'error'); return; }

      readerEl.style.display='block';
      if (!__qrReader) __qrReader = new Html5Qrcode('reader');
      __qrReader.start(
        { facingMode:'environment' },
        { fps:10, qrbox:250 },
        (decoded) => {
          input.value = decoded;
          showToast('TBR escaneado!', 'success');
          __qrReader.stop().then(()=>{ readerEl.style.display='none'; }).catch(()=>{});
        },
        () => {}
      ).catch(err => {
        console.error(err);
        readerEl.style.display='none';
        showToast('Permita o acesso à câmera', 'error');
      });
    }

    // Foto
    function previewPhoto(){
      const input = document.getElementById('photoInput');
      const preview = document.getElementById('photoPreview');
      const cameraSection = document.getElementById('cameraSection');
      if (input.files && input.files[0]){
        const reader = new FileReader();
        reader.onload = (e)=>{ currentPhoto = e.target.result; preview.src=currentPhoto; preview.classList.remove('hidden'); cameraSection.classList.add('hidden'); };
        reader.readAsDataURL(input.files[0]);
      }
    }
    function clearPhoto(){ currentPhoto=null; document.getElementById('photoPreview').classList.add('hidden'); document.getElementById('cameraSection').classList.remove('hidden'); document.getElementById('photoInput').value=''; }

    // Salvar / Limpar
    function savePackage(){
      const tbr = document.getElementById('tbrInput').value.trim();
      const motivo = document.getElementById('motivoSelect').value;
      const acao = document.getElementById('acaoSelect').value;
      const reprocessDate = document.getElementById('reprocessDate').value;
      const observacoes = document.getElementById('observacoes').value.trim();

      if (!tbr) return showToast('TBR é obrigatório!', 'error');
      if (!motivo) return showToast('Motivo é obrigatório!', 'error');
      if (!acao) return showToast('Ação é obrigatória!', 'error');
      if (acao==='Reprocessar' && !reprocessDate) return showToast('Data de reprocessamento é obrigatória!', 'error');

      const pkg = {
        id: Date.now(),
        tbr, motivo, acao,
        reprocessDate: reprocessDate || '',
        observacoes,
        photo: currentPhoto,
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleDateString('pt-BR')
      };

      packages.unshift(pkg);
      localStorage.setItem('packages', JSON.stringify(packages));
      showToast('Registro salvo com sucesso!', 'success');
      clearForm(); loadRecentRecords();
    }

    function clearForm(){
      document.getElementById('tbrInput').value='';
      document.getElementById('motivoSelect').value='';
      document.getElementById('acaoSelect').value='';
      document.getElementById('reprocessDate').value='';
      document.getElementById('observacoes').value='';
      document.getElementById('reprocessDateDiv').classList.add('hidden');
      clearPhoto();
    }

    // Lista
    function loadRecentRecords(){
      const container = document.getElementById('recentRecords');
      const today = new Date().toLocaleDateString('pt-BR');
      const todayPackages = packages.filter(p => p.date === today).slice(0, 8);

      if (todayPackages.length === 0){
        container.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg font-medium">Nenhum registro encontrado para hoje</p>
            <p class="text-gray-400 text-sm">Comece registrando seu primeiro pacote</p>
          </div>`;
        return;
      }

      container.innerHTML = todayPackages.map((pkg, index) => `
        <div class="record-card p-6 card-hover" style="animation-delay:${index*.1}s;">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center space-x-4 mb-3">
                <div class="flex items-center space-x-3">
                  <span class="text-2xl font-bold text-gray-800 font-mono">${pkg.tbr}</span>
                  <span class="status-badge status-${pkg.acao.toLowerCase().replace(/\s+/g,'-')}">${pkg.acao}</span>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <p class="text-gray-600"><i class="fas fa-exclamation-circle mr-2 text-red-500"></i><strong>Motivo:</strong> ${pkg.motivo}</p>
                ${pkg.reprocessDate ? `<p class="text-gray-600"><i class="fas fa-calendar-alt mr-2 text-blue-500"></i><strong>Reprocessar:</strong> ${new Date(pkg.reprocessDate).toLocaleDateString('pt-BR')}</p>` : ''}
                <p class="text-gray-600"><i class="fas fa-clock mr-2 text-green-500"></i><strong>Registrado:</strong> ${new Date(pkg.timestamp).toLocaleString('pt-BR')}</p>
                ${pkg.observacoes ? `<p class="text-gray-600 md:col-span-2"><i class="fas fa-comment mr-2 text-purple-500"></i><strong>Obs:</strong> ${pkg.observacoes}</p>` : ''}
              </div>
              <div class="mt-4">
                <button onclick="deletePackage(${pkg.id})" class="px-4 py-2 rounded-lg border border-red-300 text-red-600 hover:bg-red-50 transition">
                  <i class="fas fa-trash mr-2"></i>Excluir
                </button>
              </div>
            </div>
            ${pkg.photo ? `
              <div class="ml-6">
                <img src="${pkg.photo}" alt="Foto do pacote TBR ${pkg.tbr}" class="w-20 h-20 object-cover rounded-2xl cursor-pointer hover:scale-105 transition-transform shadow-lg" onclick="viewPhoto('${pkg.photo}')">
              </div>` : `
              <div class="ml-6 w-20 h-20 bg-gray-100 rounded-2xl flex items-center justify-center">
                <i class="fas fa-image text-gray-400 text-2xl"></i>
              </div>`
            }
          </div>
        </div>`).join('');
    }

    function deletePackage(id){
      packages = packages.filter(p => p.id !== id);
      localStorage.setItem('packages', JSON.stringify(packages));
      loadRecentRecords();
      showToast('Registro excluído.', 'info');
    }

    function viewPhoto(photoUrl){
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 backdrop-blur-sm';
      modal.innerHTML = `
        <div class="relative max-w-4xl max-h-4xl p-4">
          <img src="${photoUrl}" class="max-w-full max-h-full object-contain rounded-2xl shadow-2xl">
          <button onclick="this.parentElement.parentElement.remove()" class="absolute top-6 right-6 bg-white bg-opacity-20 backdrop-blur-sm text-white rounded-full w-12 h-12 flex items-center justify-center font-bold text-xl hover:bg-opacity-30 transition-all">
            <i class="fas fa-times"></i>
          </button>
        </div>`;
      document.body.appendChild(modal);
    }

    // Relatórios
    function showReports(){ generateDailyReport(document.getElementById('reportContent')); document.getElementById('reportsModal').classList.remove('hidden'); }
    function closeReports(){ document.getElementById('reportsModal').classList.add('hidden'); }
    function showHistoricalReports(){ document.getElementById('historicalModal').classList.remove('hidden'); setTimeout(()=>setQuickFilter('fc-reversa'),100); }
    function closeHistoricalReports(){ document.getElementById('historicalModal').classList.add('hidden'); }

    function setQuickFilter(type){
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      const btn = event ? event.target : document.querySelector(`[onclick*="${type}"]`); if (btn) btn.classList.add('active');

      const today = new Date(); let startDate, endDate;
      if (type==='today'){ startDate=endDate=today; }
      else if (type==='week'){ startDate=new Date(today.getTime()-7*24*60*60*1000); endDate=today; }
      else if (type==='month'){ startDate=new Date(today.getFullYear(), today.getMonth(), 1); endDate=today; }
      else { startDate=new Date(today.getTime()-30*24*60*60*1000); endDate=today; }

      document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
      document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
      filterHistoricalData(type==='fc-reversa');
    }

    function filterHistoricalData(fcReversaOnly=false){
      const startDate = new Date(document.getElementById('startDate').value);
      const endDate = new Date(document.getElementById('endDate').value);
      const content = document.getElementById('historicalContent');

      if (!startDate || !endDate) return showToast('Selecione início e fim', 'error');
      if (startDate > endDate) return showToast('Data inicial maior que final', 'error');

      let filtered = packages.filter(p => { const d = new Date(p.timestamp); return d>=startDate && d<=endDate; });
      if (fcReversaOnly) filtered = filtered.filter(p => p.acao==='FC' || p.acao==='Reversa');

      generateHistoricalReport(content, filtered, startDate, endDate, fcReversaOnly);
    }

    function generateDailyReport(container){
      const today = new Date().toLocaleDateString('pt-BR');
      const todayPkgs = packages.filter(p => p.date === today);
      const reprocessar = todayPkgs.filter(p => p.acao==='Reprocessar');
      const reversa = todayPkgs.filter(p => p.acao==='Reversa');
      const fc = todayPkgs.filter(p => p.acao==='FC');

      container.innerHTML = `
        <div class="mb-8">
          <div class="text-center mb-8">
            <h3 class="text-3xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent mb-2">Relatório Diário - ${today}</h3>
            <p class="text-gray-600">Resumo completo das atividades do dia</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stats-card p-6 text-center bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-500">
              <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl mx-auto mb-3 flex items-center justify-center text-white"><i class="fas fa-boxes text-xl"></i></div>
              <h4 class="font-bold text-blue-800 text-lg">Total de Pacotes</h4><p class="text-3xl font-bold text-blue-600">${todayPkgs.length}</p>
            </div>
            <div class="stats-card p-6 text-center bg-gradient-to-br from-yellow-50 to-yellow-100 border-l-4 border-yellow-500">
              <div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl mx-auto mb-3 flex items-center justify-center text-white"><i class="fas fa-redo-alt text-xl"></i></div>
              <h4 class="font-bold text-yellow-800 text-lg">Para Reprocessar</h4><p class="text-3xl font-bold text-yellow-600">${reprocessar.length}</p>
            </div>
            <div class="stats-card p-6 text-center bg-gradient-to-br from-red-50 to-red-100 border-l-4 border-red-500">
              <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-red-600 rounded-xl mx-auto mb-3 flex items-center justify-center text-white"><i class="fas fa-arrow-left text-xl"></i></div>
              <h4 class="font-bold text-red-800 text-lg">Para Reversa</h4><p class="text-3xl font-bold text-red-600">${reversa.length}</p>
            </div>
            <div class="stats-card p-6 text-center bg-gradient-to-br from-purple-50 to-purple-100 border-l-4 border-purple-500">
              <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl mx-auto mb-3 flex items-center justify-center text-white"><i class="fas fa-flag-checkered text-xl"></i></div>
              <h4 class="font-bold text-purple-800 text-lg">Fim de Ciclo</h4><p class="text-3xl font-bold text-purple-600">${fc.length}</p>
            </div>
          </div>
          ${generateReportSection('Pacotes para Reprocessar', reprocessar, 'yellow', 'redo-alt')}
          ${generateReportSection('Pacotes para Reversa', reversa, 'red', 'arrow-left')}
          ${generateReportSection('Pacotes FC (Fim de Ciclo)', fc, 'purple', 'flag-checkered')}
        </div>`;
    }

    function generateHistoricalReport(container, filteredPackages, startDate, endDate, fcReversaOnly){
      const reprocessar = filteredPackages.filter(p => p.acao==='Reprocessar');
      const reversa = filteredPackages.filter(p => p.acao==='Reversa');
      const fc = filteredPackages.filter(p => p.acao==='FC');

      const title = fcReversaOnly ? 'FC/Reversa' : 'Histórico';
      const subtitle = fcReversaOnly ? 'Pacotes para FC ou Reversa no período selecionado' : 'Todos os pacotes no período selecionado';

      container.innerHTML = `
        <div class="mb-8">
          <div class="text-center mb-8">
            <h3 class="text-3xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent mb-2">
              Relatório ${title} - ${startDate.toLocaleDateString('pt-BR')} a ${endDate.toLocaleDateString('pt-BR')}
            </h3>
            <p class="text-gray-600">${subtitle}</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stats-card p-6 text-center bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-500">
              <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl mx-auto mb-3 flex items-center justify-center text-white"><i class="fas fa-boxes text-xl"></i></div>
              <h4 class="font-bold text-blue-800 text-lg">Total de Pacotes</h4><p class="text-3xl font-bold text-blue-600">${filteredPackages.length}</p>
            </div>
            <div class="stats-card p-6 text-center bg-gradient-to-br from-yellow-50 to-yellow-100 border-l-4 border-yellow-500">
              <div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl mx-auto mb-3 flex items-center justify-center text-white"><i class="fas fa-redo-alt text-xl"></i></div>
              <h4 class="font-bold text-yellow-800 text-lg">Para Reprocessar</h4><p class="text-3xl font-bold text-yellow-600">${reprocessar.length}</p>
            </div>
            <div class="stats-card p-6 text-center bg-gradient-to-br from-red-50 to-red-100 border-l-4 border-red-500">
              <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-red-600 rounded-xl mx-auto mb-3 flex items-center justify-center text-white"><i class="fas fa-arrow-left text-xl"></i></div>
              <h4 class="font-bold text-red-800 text-lg">Para Reversa</h4><p class="text-3xl font-bold text-red-600">${reversa.length}</p>
            </div>
            <div class="stats-card p-6 text-center bg-gradient-to-br from-purple-50 to-purple-100 border-l-4 border-purple-500">
              <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl mx-auto mb-3 flex items-center justify-center text-white"><i class="fas fa-flag-checkered text-xl"></i></div>
              <h4 class="font-bold text-purple-800 text-lg">Fim de Ciclo</h4><p class="text-3xl font-bold text-purple-600">${fc.length}</p>
            </div>
          </div>
          ${!fcReversaOnly ? generateReportSection('Pacotes para Reprocessar', reprocessar, 'yellow', 'redo-alt') : ''}
          ${generateReportSection('Pacotes para Reversa', reversa, 'red', 'arrow-left')}
          ${generateReportSection('Pacotes FC (Fim de Ciclo)', fc, 'purple', 'flag-checkered')}
        </div>`;
    }

    function generateReportSection(title, packages, color, icon){
      if (packages.length === 0) return '';
      const colorMap = {
        yellow:{ bg:'yellow-50', border:'yellow-200', text:'yellow-800', header:'yellow-100' },
        red:{ bg:'red-50', border:'red-200', text:'red-800', header:'red-100' },
        purple:{ bg:'purple-50', border:'purple-200', text:'purple-800', header:'purple-100' }
      };
      const c = colorMap[color];
      return `
        <div class="mb-8 bg-${c.bg} rounded-2xl p-6 border border-${c.border}">
          <div class="flex items-center mb-4">
            <div class="w-10 h-10 bg-gradient-to-r from-${color}-500 to-${color}-600 rounded-xl flex items-center justify-center text-white mr-3">
              <i class="fas fa-${icon}"></i>
            </div>
            <h4 class="text-2xl font-bold text-${c.text}">${title} (${packages.length})</h4>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse bg-white rounded-xl overflow-hidden shadow-lg">
              <thead class="bg-${c.header}">
                <tr>
                  <th class="border border-${c.border} px-4 py-3 text-left font-semibold text-${c.text}"><i class="fas fa-hashtag mr-2"></i>TBR</th>
                  <th class="border border-${c.border} px-4 py-3 text-left font-semibold text-${c.text}"><i class="fas fa-exclamation-triangle mr-2"></i>Motivo</th>
                  <th class="border border-${c.border} px-4 py-3 text-left font-semibold text-${c.text}"><i class="fas fa-clock mr-2"></i>Registrado</th>
                  ${packages.some(p => p.reprocessDate) ? `<th class="border border-${c.border} px-4 py-3 text-left font-semibold text-${c.text}"><i class="fas fa-calendar-alt mr-2"></i>Reprocessar em</th>` : ''}
                  <th class="border border-${c.border} px-4 py-3 text-left font-semibold text-${c.text}"><i class="fas fa-comment mr-2"></i>Observações</th>
                </tr>
              </thead>
              <tbody>
                ${packages.map((p,i)=>`
                  <tr class="hover:bg-gray-50 transition-colors ${i%2===0?'bg-white':'bg-gray-50'}">
                    <td class="border border-gray-200 px-4 py-3 font-mono font-semibold">${p.tbr}</td>
                    <td class="border border-gray-200 px-4 py-3">${p.motivo}</td>
                    <td class="border border-gray-200 px-4 py-3">${new Date(p.timestamp).toLocaleString('pt-BR')}</td>
                    ${packages.some(x => x.reprocessDate) ? `<td class="border border-gray-200 px-4 py-3 ${p.reprocessDate?'font-semibold text-blue-600':'text-gray-400'}">${p.reprocessDate?new Date(p.reprocessDate).toLocaleDateString('pt-BR'):'-'}</td>`:''}
                    <td class="border border-gray-200 px-4 py-3">${p.observacoes || '-'}</td>
                  </tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>`;
    }

    function printReport(){ window.print(); }

    function exportReport(){
      const today = new Date().toLocaleDateString('pt-BR');
      const todayPkgs = packages.filter(p => p.date === today);
      const csv = [
        ['TBR','Motivo','Ação','Data Reprocesso','Observações','Registrado'],
        ...todayPkgs.map(p => [p.tbr,p.motivo,p.acao,p.reprocessDate||'',p.observacoes||'', new Date(p.timestamp).toLocaleString('pt-BR')])
      ].map(r=>r.join(';')).join('\n');
      downloadCSV('\ufeff'+csv, `auditoria-galpao-${today.replace(/\//g,'-')}.csv`);
      showToast('Relatório exportado com sucesso!', 'success');
    }

    function exportHistoricalReport(){
      const startDate = new Date(document.getElementById('startDate').value);
      const endDate = new Date(document.getElementById('endDate').value);
      const filtered = packages.filter(p => { const d = new Date(p.timestamp); return d>=startDate && d<=endDate; });
      const filename = `auditoria-historico-${startDate.toLocaleDateString('pt-BR').replace(/\//g,'-')}-a-${endDate.toLocaleDateString('pt-BR').replace(/\//g,'-')}.csv`;
      const csv = [
        ['TBR','Motivo','Ação','Data Reprocesso','Observações','Registrado'],
        ...filtered.map(p => [p.tbr,p.motivo,p.acao,p.reprocessDate||'',p.observacoes||'', new Date(p.timestamp).toLocaleString('pt-BR')])
     


