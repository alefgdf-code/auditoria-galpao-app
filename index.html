<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Auditoria de Galpão - Gestão de Pacotes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * { font-family: system-ui, sans-serif; }
    .card { background:#fff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.05); }
    .input { border:1px solid #ddd; border-radius:8px; padding:8px 10px; width:100%; }
    .btn { border:none; border-radius:8px; padding:8px 14px; font-weight:600; cursor:pointer; }
    .btn-primary { background:#764ba2; color:#fff; }
    .btn-dark { background:#374151; color:#fff; }
    .btn-danger { background:#fff; border:1px solid #fecaca; color:#dc2626; }
    .table th,.table td { padding:6px 10px; border-bottom:1px solid #eee; text-align:left; }
  </style>
</head>
<body class="bg-gray-100">

<header class="bg-white shadow p-4 flex justify-between">
  <h1 class="font-bold text-purple-600"><i class="fas fa-warehouse mr-2"></i>Auditoria de Galpão</h1>
  <span id="currentDate" class="text-sm text-gray-500"></span>
</header>

<main class="max-w-5xl mx-auto p-4 space-y-6">

  <!-- Formulário -->
  <section class="card p-4">
    <h2 class="text-lg font-bold mb-3">Registrar Pacote</h2>

    <!-- TBR + QR -->
    <div class="mb-3">
      <label class="block font-semibold mb-1">TBR</label>
      <div class="flex gap-2">
        <input id="tbrInput" class="input flex-1" placeholder="Digite ou escaneie o TBR">
        <button id="btnQr" class="btn btn-dark"><i class="fas fa-qrcode"></i></button>
      </div>
    </div>
    <div id="reader" style="width:320px;max-width:100%;margin:10px 0;display:none;"></div>

    <!-- Responsável -->
    <div class="mb-3">
      <label class="block font-semibold mb-1">Responsável</label>
      <input id="responsavelInput" class="input">
    </div>

    <!-- Motivo -->
    <div class="mb-3">
      <label class="block font-semibold mb-1">Motivo</label>
      <select id="motivoSelect" class="input">
        <option value="">Selecione</option>
        <option>Demaged</option>
        <option>Cancelado</option>
        <option>HELD</option>
        <option>DS</option>
        <option>DUPLICADO</option>
      </select>
    </div>

    <!-- Ação -->
    <div class="mb-3">
      <label class="block font-semibold mb-1">Ação</label>
      <select id="acaoSelect" class="input">
        <option value="">Selecione</option>
        <option>Encaminhar para o FC</option>
      </select>
    </div>

    <!-- Foto -->
    <div class="mb-3">
      <label class="block font-semibold mb-1">Foto</label>
      <img id="photoPreview" class="hidden w-40 border rounded mb-2">
      <input type="file" id="photoInput" accept="image/*" capture="environment" class="hidden">
      <div class="flex gap-2">
        <button type="button" id="btnTirarFoto" class="btn btn-dark">Tirar/Selecionar</button>
        <button type="button" id="btnLimparFoto" class="btn btn-danger">Limpar</button>
      </div>
    </div>

    <!-- Observações -->
    <div class="mb-3">
      <label class="block font-semibold mb-1">Observações</label>
      <textarea id="obsInput" class="input"></textarea>
    </div>

    <div class="flex gap-2">
      <button id="btnSalvar" class="btn btn-primary flex-1">Salvar</button>
      <button id="btnReset" class="btn btn-danger flex-1">Resetar Tudo</button>
    </div>
  </section>

  <!-- Relatório -->
  <section class="card p-4">
    <h2 class="text-lg font-bold mb-3">Relatório - FC</h2>
    <div class="flex gap-2 mb-3 flex-wrap">
      <input type="date" id="repStart" class="input">
      <input type="date" id="repEnd" class="input">
      <button id="btnFiltrar" class="btn btn-dark">Filtrar</button>
      <button id="btnExportar" class="btn btn-primary">Exportar CSV</button>
      <button id="btnExcluirFiltrados" class="btn btn-danger">Excluir Filtrados</button>
    </div>
    <div class="overflow-x-auto">
      <table class="table w-full">
        <thead class="bg-gray-50">
          <tr><th>TBR</th><th>Responsável</th><th>Motivo</th><th>Obs</th><th>Data/Hora</th><th>Foto</th><th></th></tr>
        </thead>
        <tbody id="repBody"><tr><td colspan="7" class="text-center text-gray-400 py-4">Nenhum registro</td></tr></tbody>
      </table>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
let packages = JSON.parse(localStorage.getItem('packages')||'[]');
let currentPhoto = null;
const $=id=>document.getElementById(id);
$('currentDate').textContent=new Date().toLocaleString('pt-BR');

// foto
$('btnTirarFoto').onclick=()=>$('photoInput').click();
$('photoInput').onchange=()=>{
  if($('photoInput').files[0]){
    const r=new FileReader();
    r.onload=e=>{currentPhoto=e.target.result;$('photoPreview').src=currentPhoto;$('photoPreview').classList.remove('hidden');};
    r.readAsDataURL($('photoInput').files[0]);
  }
}
$('btnLimparFoto').onclick=()=>{currentPhoto=null;$('photoPreview').classList.add('hidden');$('photoInput').value='';};

// QR
let qrScanner=null;
$('btnQr').onclick=()=>{
  if(!qrScanner) qrScanner=new Html5Qrcode("reader");
  $('reader').style.display='block';
  qrScanner.start({facingMode:'environment'},{fps:10,qrbox:250},txt=>{
    $('tbrInput').value=txt;qrScanner.stop().then(()=>$('reader').style.display='none');
  });
};

// salvar
$('btnSalvar').onclick=()=>{
  const tbr=$('tbrInput').value.trim();
  const resp=$('responsavelInput').value.trim();
  const mot=$('motivoSelect').value;
  const acao=$('acaoSelect').value;
  const obs=$('obsInput').value.trim();
  if(!tbr||!resp||!mot||!acao) return alert('Preencha todos os campos');
  packages.unshift({id:Date.now(),tbr,responsavel:resp,motivo:mot,acao,obs,photo:currentPhoto,time:new Date().toISOString()});
  localStorage.setItem('packages',JSON.stringify(packages));
  alert('Salvo!');
  $('tbrInput').value='';$('responsavelInput').value='';$('motivoSelect').value='';$('acaoSelect').value='';$('obsInput').value='';
  currentPhoto=null;$('photoPreview').classList.add('hidden');$('photoInput').value='';
  renderReport();
};

// reset
$('btnReset').onclick=()=>{if(confirm('Apagar tudo?')){packages=[];localStorage.removeItem('packages');renderReport();}}

// relatório
function renderReport(){
  const start=new Date($('repStart').value||'1970-01-01');
  const end=new Date($('repEnd').value||'2999-12-31'); end.setHours(23,59,59,999);
  const rows=packages.filter(p=>p.acao.includes('FC')).filter(p=>{const d=new Date(p.time);return d>=start&&d<=end;});
  if(!rows.length){$('repBody').innerHTML='<tr><td colspan="7" class="text-center text-gray-400 py-4">Nenhum registro</td></tr>';return;}
  $('repBody').innerHTML=rows.map(p=>`
    <tr>
      <td>${p.tbr}</td><td>${p.responsavel}</td><td>${p.motivo}</td><td>${p.obs||''}</td>
      <td>${new Date(p.time).toLocaleString('pt-BR')}</td>
      <td>${p.photo?'<img src="'+p.photo+'" class="w-12 h-12 object-cover">':''}</td>
      <td><button onclick="del(${p.id})" class="btn btn-danger">Excluir</button></td>
    </tr>`).join('');
}
window.del=id=>{packages=packages.filter(p=>p.id!==id);localStorage.setItem('packages',JSON.stringify(packages));renderReport();}

$('btnFiltrar').onclick=renderReport;
$('btnExportar').onclick=()=>{
  const trs=[...$('repBody').querySelectorAll('tr')];
  if(!trs.length) return;
  let csv="TBR;Responsável;Motivo;Obs;Data/Hora\n";
  trs.forEach(tr=>{
    const tds=tr.querySelectorAll('td');
    if(tds.length) csv+=[...tds].slice(0,5).map(td=>td.innerText).join(';')+"\n";
  });
  const blob=new Blob(['\ufeff'+csv],{type:'text/csv'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="relatorio-fc.csv";a.click();
};
$('btnExcluirFiltrados').onclick=()=>{
  if(!confirm('Excluir todos filtrados?'))return;
  const start=new Date($('repStart').value||'1970-01-01');
  const end=new Date($('repEnd').value||'2999-12-31'); end.setHours(23,59,59,999);
  packages=packages.filter(p=>!(p.acao.includes('FC')&&new Date(p.time)>=start&&new Date(p.time)<=end));
  localStorage.setItem('packages',JSON.stringify(packages));renderReport();
};

// datas padrão
const now=new Date();$('repEnd').value=now.toISOString().split('T')[0];
const startMonth=new Date(now.getFullYear(),now.getMonth(),1);$('repStart').value=startMonth.toISOString().split('T')[0];
renderReport();
</script>
</body>
</html>
