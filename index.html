<script>
// Utilitário: blob -> DataURL
function blobToDataURL(blob){
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onerror = reject;
    fr.onload = () => resolve(fr.result);
    fr.readAsDataURL(blob);
  });
}

// 1) Exportar ZIP (CSV + fotos)
document.getElementById('btnExportarZip').addEventListener('click', async () => {
  const rows = getFilteredFC();
  if (!rows.length) { alert('Nada para exportar.'); return; }

  const zip = new JSZip();
  const fotosFolder = zip.folder('fotos');

  // Monta CSV com referência ao arquivo da foto (se tiver)
  const header = ['TBR','Responsável','Motivo','Obs','Data','Hora','ArquivoFoto'];
  const csvLines = [header.join(';')];

  // Adiciona fotos e preenche linhas
  for (const p of rows){
    const d = new Date(p.time);
    const dataBR = d.toLocaleDateString('pt-BR');
    const horaBR = d.toLocaleTimeString('pt-BR');

    let fotoNome = '';
    if (p.photoId){
      try {
        const blob = await getPhoto(p.photoId);
        if (blob){
          // Nome de arquivo legível
          fotoNome = `fotos/${(p.tbr || 'sem_tbr').replace(/[^A-Za-z0-9_-]/g,'_')}_${p.id}.jpg`;
          fotosFolder.file(fotoNome.split('/').pop(), blob); // só o nome dentro da pasta
        }
      } catch(e){ /* sem foto */ }
    }

    const linha = [
      p.tbr,
      p.responsavel,
      p.motivo,
      (p.obs || '').replaceAll(';', ','),
      dataBR,
      horaBR,
      fotoNome
    ].join(';');
    csvLines.push(linha);
  }

  zip.file('relatorio.csv', '\ufeff' + csvLines.join('\n')); // BOM p/ Excel PT-BR

  const blobZip = await zip.generateAsync({ type: 'blob' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blobZip);
  const dt = new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
  a.download = `relatorio-fc_${dt}.zip`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
});

// 2) Exportar HTML com fotos embutidas (um arquivo só)
document.getElementById('btnExportarHTML').addEventListener('click', async () => {
  const rows = getFilteredFC();
  if (!rows.length) { alert('Nada para exportar.'); return; }

  // Monta linhas com <img src="data:image/jpeg;base64,...">
  const trs = [];
  for (const p of rows){
    const d = new Date(p.time);
    const dataBR = d.toLocaleDateString('pt-BR');
    const horaBR = d.toLocaleTimeString('pt-BR');
    let imgTag = '';

    if (p.photoId){
      try {
        const blob = await getPhoto(p.photoId);
        if (blob){
          const dataURL = await blobToDataURL(blob); // incorpora imagem no HTML
          imgTag = `<img src="${dataURL}" style="width:70px;height:70px;object-fit:cover;border-radius:8px;border:1px solid #eee" alt="Foto">`;
        }
      } catch(e){ /* sem foto */ }
    }

    trs.push(`
      <tr>
        <td>${p.tbr}</td>
        <td>${p.responsavel}</td>
        <td>${p.motivo}</td>
        <td>${(p.obs || '').replace(/</g,'&lt;')}</td>
        <td>${dataBR}</td>
        <td>${horaBR}</td>
        <td>${imgTag}</td>
      </tr>
    `);
  }

  const html = `<!DOCTYPE html>
  <html lang="pt-BR"><head>
    <meta charset="utf-8">
    <title>Relatório FC</title>
    <style>
      body { font-family: Arial, sans-serif; padding:16px; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border:1px solid #ddd; padding:8px; font-size:14px; }
      th { background:#f7f7f7; text-align:left; }
      h1 { margin:0 0 12px 0; font-size:18px; }
      .muted { color:#666; font-size:12px; margin-bottom:12px; }
    </style>
  </head><body>
    <h1>Relatório — Devolução FC</h1>
    <div class="muted">Gerado em ${new Date().toLocaleString('pt-BR')}</div>
    <table>
      <thead>
        <tr>
          <th>TBR</th><th>Responsável</th><th>Motivo</th><th>Obs</th>
          <th>Data</th><th>Hora</th><th>Foto</th>
        </tr>
      </thead>
      <tbody>${trs.join('')}</tbody>
    </table>
  </body></html>`;

  const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const dt = new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
  a.download = `relatorio-fc_${dt}.html`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
});
</script>
